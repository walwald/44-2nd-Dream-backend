# Dream - Backend

**ìœ„ì½”ë“œ 44ê¸° 2ì°¨ í”„ë¡œì íŠ¸ <br>
c2c ëª…í’ˆ ê²½ë§¤ í”Œë«í¼ KREAMì„ ëª¨ë¸ë§í•˜ì—¬ ë ˆê³  ìƒí’ˆ c2c ê²½ë§¤ í”Œë«í¼ ì›¹ì‚¬ì´íŠ¸ ì œì‘<br>
[ê²°ê³¼ë¬¼ ì‹œì—° ì˜ìƒ ë§í¬](https://www.youtube.com/watch?v=UFuS91VcVp8)**

> **ì§§ì€ í”„ë¡œì íŠ¸ ê¸°ê°„ë™ì•ˆ ê°œë°œì— ì§‘ì¤‘í•´ì•¼ í•˜ë¯€ë¡œ ë””ìì¸/ê¸°íš ë¶€ë¶„ë§Œ í´ë¡ í–ˆìŠµë‹ˆë‹¤.<br>
ê°œë°œì€ ì´ˆê¸° ì„¸íŒ…ë¶€í„° ì „ë¶€ ì§ì ‘ êµ¬í˜„í–ˆìœ¼ë©°, ì•„ë˜ ë°ëª¨ ì˜ìƒì—ì„œ ë³´ì´ëŠ” ë¶€ë¶„ì€ ëª¨ë‘ ë°±ì•¤ë“œì™€ ì—°ê²°í•˜ì—¬ ì‹¤ì œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì„œë¹„ìŠ¤ ìˆ˜ì¤€ìœ¼ë¡œ ê°œë°œí•œ ê²ƒì…ë‹ˆë‹¤.*


## 1. í”„ë¡œì íŠ¸ ê¸°ê°„ & ì¸ì›
* í”„ë¡œì íŠ¸ ê¸°ê°„: 2ì£¼ (2023.04.20 ~ 2023.05.04)   
* ê°œë°œ ì¸ì›:  
  `Frontend`: ìµœì„ ì˜(Product Manager), ê¹€ì˜ìš´, ì¡°ê±´í˜¸ <br>
  `Backend`: ë°•ì„¸ìµ(Project Manager), ì¥ë‹¤í¬, ê¹€ë¯¼ì„œ, ì†¡ì„ì¤€ <br>
* [í”„ë¡ íŠ¸ì—”ë“œ Github ì €ì¥ì†Œ](https://github.com/wecode-bootcamp-korea/44-2nd-Dream-frontend)
* ëª¨ë¸ë§í•œ ì‚¬ì´íŠ¸: [KREAM](https://kream.co.kr/)

<br>


## 2. ì‚¬ìš© ê¸°ìˆ 

* **BackEnd** <br>

   JavaScript <br>
   Node.js v16.15 <br>
   express 4.18 <br>
   Jest 29.5 <br>
   MySql 5.7 <br>
   Rest <br>
   Prettier <br>
   Docker <br>
   AWS <br>
 
<br>

* **í˜‘ì—…** <br>

  Git & Git hub <br>
  Trello <br>
  Postman <br>
  Slack <br>
  Notion <br>

<br>


 ## 3. [ERD](https://dbdiagram.io/d/64426bdf6b31947051f9b394)
 Userê°€ êµ¬ë§¤ìì´ì íŒë§¤ìê°€ ë  ìˆ˜ ìˆìœ¼ë©°, í•˜ë‚˜ì˜ Productì— êµ¬ë§¤ ì…ì°°ê³¼ íŒë§¤ ì…ì°°ì´ ë™ì‹œì— ì´ë£¨ì–´ì§„ë‹¤ëŠ” ì ì— ì£¼ì•ˆì ì„ ë‘ê³  ë°ì´í„°ë² ì´ìŠ¤ ëª¨ë¸ì„ êµ¬ì¶•í•˜ì˜€ìŠµë‹ˆë‹¤. <br><br>
![DREAM (3)](https://github.com/wecode-bootcamp-korea/44-2nd-Dream-backend/assets/120387100/b18561e6-0888-4aaa-8eaa-452122d73e11)

 
 ## 4. í•µì‹¬ ê¸°ëŠ¥
 
 c2c ê²½ë§¤ í”Œë«í¼ìœ¼ë¡œì„œ ê°–ì¶”ì–´ì•¼ í•  í•„ìˆ˜ ê¸°ëŠ¥ë“¤ì„ êµ¬í˜„ í•˜ì˜€ìŠµë‹ˆë‹¤.
 
<details>
<summary>í•µì‹¬ ê¸°ëŠ¥ ì„¤ëª… í¼ì¹˜ê¸°</summary>
<div markdown="1">
 
<br>
  
 **1. íšŒì›ê°€ì…/ë¡œê·¸ì¸(Kakao Social Login)** ğŸ“Œ[ì½”ë“œ í™•ì¸](https://github.com/walwald/44-2nd-Dream-backend/blob/669cc7d2ba9331583cc76f30c1f8cf3e2cda6e40/API/services/userService.js#L6)
 - KaKaoì—ì„œ ì œê³µí•˜ëŠ” APIë¥¼ í™œìš©í•˜ì—¬ user íšŒì› ê°€ì…, ë¡œê·¸ì¸ ê¸°ëŠ¥ì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.
 
 <br>
 
**2. ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ (í•„í„°/ì •ë ¬)** ğŸ“Œ[ì½”ë“œ í™•ì¸](https://github.com/walwald/44-2nd-Dream-backend/blob/669cc7d2ba9331583cc76f30c1f8cf3e2cda6e40/API/models/productDao.js#L57)
  
- query parameterë¡œ í•„í„° ë° ì •ë ¬ ì¡°ê±´ì„ ì „ë‹¬ ë°›ì•„, ê·¸ì— ë”°ë¼ ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ë¥¼ ì‘ë‹µí•˜ëŠ” APIì…ë‹ˆë‹¤.
- ì¢‹ì•„ìš” ë§ì€ ìˆœ, ì¦‰ì‹œ êµ¬ë§¤ê°€ ìˆœ, ì¦‰ì‹œ íŒë§¤ê°€ ìˆœ, ë¦¬ë·° ìˆœ, í”„ë¦¬ë¯¸ì—„ ê°€ê²© ìˆœìœ¼ë¡œ ì •ë ¬ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
- ìƒí’ˆ ì¹´í…Œê³ ë¦¬, ì‚¬ìš© ì—°ë ¹, ë‚œì´ë„ë¡œ í•„í„° ê°€ëŠ¥í•©ë‹ˆë‹¤.

<br>

**3. ìƒí’ˆ ìƒì„¸ ì •ë³´** ğŸ“Œ[ì½”ë“œ í™•ì¸](https://github.com/walwald/44-2nd-Dream-backend/blob/669cc7d2ba9331583cc76f30c1f8cf3e2cda6e40/API/services/productService.js#L5)

- path parameterë¡œ productIdë¥¼ ì „ë‹¬ ë°›ì•„, í•´ë‹¹í•˜ëŠ” productì˜ ìƒì„¸ ì •ë³´ë¥¼ ì‘ë‹µí•˜ëŠ” APIì…ë‹ˆë‹¤.
- ìƒí’ˆëª…, ëª¨ë¸ë„˜ë²„, ì¹´í…Œê³ ë¦¬, ì¢‹ì•„ìš” ìˆ˜ ë“± ê¸°ë³¸ ì •ë³´ ë¿ë§Œ ì•„ë‹ˆë¼, ì¦‰ì‹œ êµ¬ë§¤ê°€, ì¦‰ì‹œ íŒë§¤ê°€, ìµœê·¼ ê±°ë˜ê°€, í”„ë¦¬ë¯¸ì—„ í¼ì„¼íŠ¸ ë“±ì˜ ê²½ë§¤ê°€ ê´€ë ¨ ë°ì´í„°ë„ í•¨ê»˜ ì „ë‹¬í•©ë‹ˆë‹¤.
- `ì¦‰ì‹œ êµ¬ë§¤ê°€`ëŠ” íŒë§¤ ì…ì°°ëœ ê¸ˆì•¡ ì¤‘ ê°€ì¥ ë‚®ì€ ê¸ˆì•¡, `ì¦‰ì‹œ íŒë§¤ê°€`ëŠ” êµ¬ë§¤ ì…ì°°ëœ ê¸ˆì•¡ ì¤‘ ê°€ì¥ ë†’ì€ ê¸ˆì•¡, `ìµœê·¼ ê±°ë˜ê°€`ëŠ” ì²´ê²° ê±°ë˜ ì¤‘ ê°€ì¥ ìµœì‹  ê±°ë˜ì˜ ê±°ë˜ ì„±ì‚¬ ê°€ê²©ì…ë‹ˆë‹¤.
- `í”„ë¦¬ë¯¸ì—„ í¼ì„¼íŠ¸`ëŠ” ìƒí’ˆ ë°œë§¤ê°€ì™€ ìµœê·¼ ê±°ë˜ê°€ì˜ ë¹„ìœ¨ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.

<br>

**4. ì…ì°°** ğŸ“Œ[ì½”ë“œ í™•ì¸](https://github.com/walwald/44-2nd-Dream-backend/blob/a51ad73eea353c5395936e41337ced2c525ba9d9/API/models/bidDao.js#L126)

- `ìƒí’ˆ productId`, `êµ¬ë§¤/íŒë§¤ ì¤‘ í•´ë‹¹í•˜ëŠ” ì…ì°° ìœ í˜•`, `ì…ì°° ê¸ˆì•¡`, `ì…ì°° ë§ˆê° ê¸°í•œ`ì„ requestì˜ bodyë¡œ ì „ë‹¬ë°›ì•„ ì…ì°° ë‚´ì—­ì´ ê¸°ë¡ë˜ëŠ” APIì…ë‹ˆë‹¤.
- `êµ¬ë§¤ ì…ì°°`, `ì¦‰ì‹œ êµ¬ë§¤`, `íŒë§¤ ì…ì°°`, `ì¦‰ì‹œ íŒë§¤` ë„¤ ê°€ì§€ ê²½ìš°ì— ëª¨ë‘ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- userIdëŠ” tokenì˜ payloadì— ì €ì¥ëœ ì •ë³´ë¥¼ ì´ìš©í•©ë‹ˆë‹¤.
- ì…ì°° ê¸ˆì•¡ì— ë”°ë¼ ì¦‰ì‹œ ê±°ë˜ê°€ ì„±ì‚¬ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ì¦‰ì‹œ ê±°ë˜ê°€ ì„±ì‚¬ë˜ëŠ” ê²½ìš°, transactionì„ ì‚¬ìš©í•˜ì—¬ `ê±°ë˜ ê±´ ìƒì„±`, `ì…ì°° ìƒíƒœë¥¼ ë‚™ì°°ë¡œ ë³€ê²½`, `ê±°ë˜ ìƒëŒ€ë°©ì˜ ì…ì°° ë‚´ì—­ë„ ë‚™ì°° ìƒíƒœë¡œ ë³€ê²½` ë“±ì˜ ì²˜ë¦¬ê°€ ë™ì‹œì— ì´ë£¨ì–´ì§€ë„ë¡ í–ˆìŠµë‹ˆë‹¤.
- í•´ë‹¹ userì™€ ìƒí’ˆì— ëŒ€í•´ ê¸°ì¡´ ì…ì°° ë‚´ì—­ì´ ì¡´ì¬í•  ê²½ìš° 'ê¸ˆì•¡' í˜¹ì€ 'ì…ì°° ê¸°í•œ'ì´ ë³€ê²½ë˜ë„ë¡ í•˜ì—¬, ì…ì°° ê±´ ìƒì„± ì™¸ì—ë„ ì…ì°° ë‚´ì—­ ì—…ë°ì´íŠ¸ì— ë³¸ APIê°€ ì‚¬ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<br>
 
**5. ì…ì°° ìƒì„¸ ë‚´ì—­ ì¡°íšŒ** ğŸ“Œ[ì½”ë“œ í™•ì¸](https://github.com/walwald/44-2nd-Dream-backend/blob/a51ad73eea353c5395936e41337ced2c525ba9d9/API/services/bidService.js#L36)

- ì…ì°° ê¸ˆì•¡ ë° ê¸°í•œ ì…ë ¥ í›„ ì´ì–´ì§€ëŠ” ê°œì¸ ì •ë³´ ì…ë ¥ í˜ì´ì§€ì—ì„œ ì…ì°° ë‚´ì—­ í™•ì¸ì„ ìœ„í•œ ì…ì°° ìƒì„¸ ì •ë³´ ì¡°íšŒ APIì…ë‹ˆë‹¤.
- path parameterë¡œ ìƒí’ˆì˜ productIdë¥¼, query parameterë¡œ êµ¬ë§¤/íŒë§¤ ë“±ì˜ ì…ì°° ìœ í˜•ì„ ì „ë‹¬ ë°›ìŠµë‹ˆë‹¤. userIdëŠ” tokenì˜ payloadì— ì €ì¥ëœ ì •ë³´ë¥¼ ì´ìš©í•©ë‹ˆë‹¤.
- ê±°ë˜ ì„±ì‚¬ ì—¬ë¶€ì— ë”°ë¼ dealId(ê±°ë˜ Id)ì™€ dealNumber(ê³ ìœ  ê±°ë˜ ë²ˆí˜¸) ì „ë‹¬ ì—¬ë¶€ê°€ ë‹¬ë¼ì§‘ë‹ˆë‹¤. ê±°ë˜ê°€ ì„±ì‚¬ë˜ì§€ ì•Šê³  ì…ì°°ë§Œ ì™„ë£Œëœ ê²½ìš° ë‘ ê°’ì„ nullë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.
- ìƒí’ˆì— ëŒ€í•œ ê¸°ë³¸ ì •ë³´ì™€, ì…ì°° ê±´ì˜ Id, ì…ì°° ê¸ˆì•¡, ì…ì°° ê¸°í•œ, ìˆ˜ìˆ˜ë£Œ ê¸ˆì•¡ ë“±ì„ ì „ë‹¬í•©ë‹ˆë‹¤.
 
 
 <br>

 **6. ìƒí’ˆ ê²€ìƒ‰** ğŸ“Œ[ì½”ë“œ í™•ì¸](https://github.com/walwald/44-2nd-Dream-backend/blob/a6898307b9601db0e41209f16a1fce26dc5efea4/API/models/searchDao.js#L4)
 
 - keywordì— ìƒí’ˆëª… ë˜ëŠ” basic, building, movie, car ë“±ì˜ ì¹´í…Œê³ ë¦¬ ëª… ê¸°ì… ì‹œ ê²€ìƒ‰ë©ë‹ˆë‹¤.
 
  <br>
  
 **7. ì¸ê¸° ê²€ìƒ‰ì–´**
 - ëˆ„ì  ì¸ê¸°ê²€ìƒ‰ì–´ë¥¼ ì¡°íšŒí•˜ëŠ” APIì…ë‹ˆë‹¤.
 - ê²€ìƒ‰ ì‹œ í‚¤ì›Œë“œë³„ ê²€ìƒ‰ëŸ‰ì´ ëˆ„ì ë©ë‹ˆë‹¤. ğŸ“Œ[ì½”ë“œ í™•ì¸](https://github.com/walwald/44-2nd-Dream-backend/blob/a6898307b9601db0e41209f16a1fce26dc5efea4/API/models/searchDao.js#L32)
 - ê²€ìƒ‰ì–´ ë°ì´í„°ë¥¼ ì—­ëŒ€ ê²€ìƒ‰ëŸ‰ ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ìƒìœ„ 10ê°œì˜ ê²€ìƒ‰ì–´ë¥¼ ì‘ë‹µí•©ë‹ˆë‹¤. ğŸ“Œ[ì½”ë“œ í™•ì¸](https://github.com/walwald/44-2nd-Dream-backend/blob/a6898307b9601db0e41209f16a1fce26dc5efea4/API/models/searchDao.js#L48)

  <br>
  
**8. ê´€ì‹¬ìƒí’ˆ ë“±ë¡/ì‚­ì œ** ğŸ“Œ[ì½”ë“œ í™•ì¸](https://github.com/walwald/44-2nd-Dream-backend/blob/a6898307b9601db0e41209f16a1fce26dc5efea4/API/services/likeService.js#L3)
- path parameterë¡œ productIdë¥¼ ë°›ì•„ í•´ë‹¹ ìœ ì €ì˜ ê´€ì‹¬ìƒí’ˆìœ¼ë¡œ ë“±ë¡í•©ë‹ˆë‹¤.
- ë™ì¼í•œ productì™€ ë™ì¼í•œ userì— ëŒ€í•´ APIê°€ ì¬ì‹¤í–‰ë  ê²½ìš° ê´€ì‹¬ìƒí’ˆì—ì„œ ì‚­ì œí•©ë‹ˆë‹¤.
  
  <br>

 **9. ë¦¬ë·° CRUD**
 
 - ìƒì„±: multer-3ì™€ multerë¥¼ ì´ìš©í•˜ì—¬ ì„œë²„ ì¸¡ì—ì„œ AWSì˜ S3ì— ì‚¬ì§„ì„ ì˜¬ë ¤ ì‚¬ì§„ ë¦¬ë·° ê²Œì‹œê°€ ê°€ëŠ¥í•˜ë„ë¡ í–ˆìŠµë‹ˆë‹¤. ğŸ“Œ[ì½”ë“œ í™•ì¸](https://github.com/walwald/44-2nd-Dream-backend/blob/a6898307b9601db0e41209f16a1fce26dc5efea4/API/routes/reviewRouter.js#L9)
 - ì¡°íšŒ: ë¦¬ë·° ì¡°íšŒ ì‹œ productIdë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì œí’ˆì— ëŒ€í•œ ë¦¬ë·°ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤. users ë° review_images í…Œì´ë¸”ê³¼ LEFT JOIN í•˜ì—¬ ë°ì´í„°ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. ğŸ“Œ[ì½”ë“œ í™•ì¸](https://github.com/walwald/44-2nd-Dream-backend/blob/a6898307b9601db0e41209f16a1fce26dc5efea4/API/models/reviewDao.js#L5)
 - ìˆ˜ì •: ìœ íš¨í•œ reviewIdì¸ì§€ í™•ì¸ í›„ ë¦¬ë·°ê°€ ìˆ˜ì •ë˜ë„ë¡ í–ˆìŠµë‹ˆë‹¤. ğŸ“Œ[ì½”ë“œ í™•ì¸](https://github.com/walwald/44-2nd-Dream-backend/blob/a6898307b9601db0e41209f16a1fce26dc5efea4/API/services/reviewService.js#L24)
 - ì‚­ì œ: ë¦¬ë·°ì™€ ë¦¬ë·° ì´ë¯¸ì§€ ì‚­ì œì— ëŒ€í•´ transaction ì²˜ë¦¬ í•˜ì˜€ìŠµë‹ˆë‹¤. ğŸ“Œ[ì½”ë“œ í™•ì¸](https://github.com/walwald/44-2nd-Dream-backend/blob/a6898307b9601db0e41209f16a1fce26dc5efea4/API/models/reviewDao.js#L64)

  <br>
  
  **10. ê²°ì œ/ì •ì‚° ì™„ë£Œ ìƒíƒœ ì—…ë°ì´íŠ¸** ğŸ“Œì½”ë“œ í™•ì¸ - [íŒë§¤](https://github.com/walwald/44-2nd-Dream-backend/blob/a6898307b9601db0e41209f16a1fce26dc5efea4/API/models/paymentDao.js#L100), [êµ¬ë§¤](https://github.com/walwald/44-2nd-Dream-backend/blob/a6898307b9601db0e41209f16a1fce26dc5efea4/API/models/paymentDao.js#L169)
  - ì¦‰ì‹œ êµ¬ë§¤ í›„ clientê°€ ê²°ì œ ì™„ë£Œ ìš”ì²­ì„ ë³´ë‚´ë©´, ê±°ë˜ ìƒíƒœë¥¼ `ê²°ì œ ì™„ë£Œ`ë¡œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤. 
  - ì¦‰ì‹œ íŒë§¤ê°€ ì²´ê²°ë˜ë©´ êµ¬ë§¤ìì˜ `ê²°ì œ ëŒ€ê¸°`ë¡œ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸ í•©ë‹ˆë‹¤.
  
<br>
  
  </div>
</details>

- [Postman](https://documenter.getpostman.com/view/26858291/2s93eWzskR): í”„ë¡œì íŠ¸ ì§„í–‰ ì‹œ Postmanì˜ Documentationì„ í™œìš©í•˜ì—¬ í”„ë¡ íŠ¸ì—”ë“œì™€ ì†Œí†µí•˜ì˜€ìŠµë‹ˆë‹¤.
clientê°€ ì‚¬ìš©í•œ ëª¨ë“  APIë¥¼ Postmanì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<br>

 ## 5. í•µì‹¬ íŠ¸ëŸ¬ë¸” ìŠˆíŒ…
 #### 1. ìƒí’ˆ ìƒì„¸ ì •ë³´ í˜¸ì¶œ API - SELECT ì¿¼ë¦¬ë¬¸ì˜ ì˜¤ì‚¬ìš©
 - ìƒí’ˆ ìƒì œ ì •ë³´ í˜¸ì¶œ API ì‘ì„± í›„ APIê°€ ì˜ ì‹¤í–‰ë˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” ê³¼ì •ì—ì„œ ê° í…Œì´ë¸”ì— ë°ì´í„°ë¥¼ 1ê°œì”©ë§Œ ìƒì„±í•˜ê³  í…ŒìŠ¤íŠ¸í•˜ì—¬, SELECT ë¬¸ ë‚´ suq-queryê°€ 2ê°œ ì´ìƒì˜ rowë¥¼ ë°˜í™˜í•œë‹¤ëŠ” ì‚¬ì‹¤ì„ ë°œê²¬í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.
 
    <details>
    <summary>ê¸°ì¡´ ì½”ë“œ</summary>
    <div markdown="1">

    ```JavaScript
    //API/models/productDao.js
    const productDetail = async (productId) => {
      try {
        const [productDetail] = await appDataSource.query(
          `
            SELECT 
                p.name productName,
                p.model_number modelNumber,
                c.name categoryName,
                p.original_price originalPrice,
                pi.url imageUrl,
                pa.age productAge,
                pl.level productLevel,
                (SELECT 
                    b.bid_price
                FROM buyings b
                JOIN deals d
                ON d.buying_id = b.id
                WHERE d.created_at = (SELECT max(created_at) FROM deals)) recentDealPrice,
                (SELECT 
                    bid_price
                FROM sellings
                WHERE bid_price = (SELECT min(bid_price) FROM sellings WHERE bid_status_id = 1)) buyNowPrice,
                (SELECT 
                    bid_price
                FROM buyings
                WHERE bid_price = (SELECT max(bid_price) FROM buyings WHERE bid_status_id = 1)) sellNowPrice,
                (SELECT 
                  COUNT(user_id)
                FROM likes
                GROUP BY product_id) likeCount
            FROM products p
            JOIN categories c ON p.category_id = c.id
            JOIN product_images pi ON p.id = pi.product_id
            JOIN product_ages pa ON p.product_age_id = pa.id
            JOIN product_levels pl ON p.product_level_id = pl.id
            LEFT JOIN buyings b ON b.product_id = p.id
            LEFT JOIN sellings s ON s.product_id = p.id
            LEFT JOIN likes l ON l.product_id = p.id
            WHERE p.id = ?
        `,
          [productId]
        );
        return productDetail;
      } catch (err) {
        err.message = 'DATABASE_ERROR';
        err.statusCode = 400;
        throw err;
      }
    };
    ```
    </div>
    </details>

- github push í›„ ì—ëŸ¬ë¥¼ ì¸ì§€í•˜ê³ , queryë¬¸ì˜ êµ¬ì¡°ë¥¼ ìˆ˜ì •í•˜ì˜€ìŠµë‹ˆë‹¤.
- 'ìµœê·¼ ê±°ë˜ê°€(recent deal price)','ì¦‰ì‹œ êµ¬ë§¤ê°€(buy now price)', 'ì¦‰ì‹œ íŒë§¤ê°€(sell now price)'ì˜ ê²½ìš° ì¬í™œìš©ì„±ì„ ê³ ë ¤í•˜ì—¬ ë³„ë„ì˜ í•¨ìˆ˜ë¡œ ë¶„ë¦¬ì‹œì¼°ìŠµë‹ˆë‹¤.
- APIë¥¼ ì‘ì„±í•  ë•Œì—ëŠ” ë°˜ë“œì‹œ ë‹¤ì–‘í•œ í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸ë¥¼ í•´ì•¼ í•œë‹¤ëŠ” ì‚¬ì‹¤ì„ ê¹¨ë‹¬ì•˜ìŠµë‹ˆë‹¤.


  <details>
  <summary>ìˆ˜ì •ëœ ì½”ë“œ</summary>
  <div markdown="1">

  - ìƒí’ˆ ìƒì„¸ ì •ë³´ í˜¸ì¶œ í•¨ìˆ˜ ('ìµœê·¼ ê±°ë˜ê°€(recent deal price)','ì¦‰ì‹œ êµ¬ë§¤ê°€(buy now price)', 'ì¦‰ì‹œ íŒë§¤ê°€(sell now price)' ì œì™¸)

  ```JavaScript
  //API/models/productDao.js
  //3ê°€ì§€ ê¸ˆì•¡ ì •ë³´ë¥¼ ì œì™¸í•œ ìƒí’ˆ ë””í…Œì¼ ì •ë³´ í˜¸ì¶œ í•¨ìˆ˜ ìµœì¢… ver.

  const productDetail = async (productId) => {
    try {
      const [productDetail] = await appDataSource.query(
        `
          SELECT 
              p.id productId,
              p.name productName,
              p.model_number modelNumber,
              c.name categoryName,
              p.original_price originalPrice,
              pi.url imageUrl,
              pa.age productAge,
              pl.level productLevel,
              l.likeCount
          FROM products p
          JOIN categories c ON p.category_id = c.id
          JOIN product_images pi ON p.id = pi.product_id
          JOIN product_ages pa ON p.product_age_id = pa.id
          JOIN product_levels pl ON p.product_level_id = pl.id
          LEFT JOIN (SELECT 
              product_id,
              COUNT(id) likeCount
           FROM likes
           GROUP BY product_id) l ON l.product_id = p.id
          WHERE p.id = ?
                `,
        [productId]
      );
      return productDetail;
    } catch (err) {
      throw new DatabaseError('DATABASE_ERROR');
    }
  };

  ```
  <br>

  - 'ìµœê·¼ ê±°ë˜ê°€(recent deal price)','ì¦‰ì‹œ êµ¬ë§¤ê°€(buy now price)', 'ì¦‰ì‹œ íŒë§¤ê°€(sell now price)' ë„ì¶œ ë©”ì„œë“œ

  ```JavaScript
  //API/models/bidDao.js
  const appDataSource = require('./appDataSource');
  const { bidStatusEnum } = require('./enum');
  const { DatabaseError } = require('../utils/error');

  class BidCase {
    constructor(productId, bidType, bidPrice) {
      this.bidType = bidType;
      this.bidPrice = bidPrice;
      this.productId = productId;
      this.counterpart = bidType == 'buying' ? 'selling' : 'buying';
      this.commissionRate = bidType == 'buying' ? 0.02 : 0.05;
      this.table = `${bidType}s`;
      this.counterTable = `${this.counterpart}s`;
      this.minOrMax = this.counterpart == 'selling' ? 'min' : 'max';
      this.appDataSource = appDataSource;
    }

   async nowPriceSetter(productIdValue, table, minOrMax) {
      try {
        const [bidPrice] = await this.appDataSource.query(
          ` 
          SELECT 
              bid_price bidPrice
          FROM ${table}
          WHERE bid_price = (
            SELECT ${minOrMax}(bid_price) 
            FROM ${table} 
            WHERE bid_status_id = ${bidStatusEnum.bid} 
            AND product_id = ${productIdValue}) 
          `
        );

        if (bidPrice == undefined) {
          return null;
        }

        return parseFloat(Object.values(bidPrice));
      } catch (err) {
        throw new DatabaseError('DATABASE_ERROR');
      }
    }

    getBuyNowPrice() {
      return this.nowPriceSetter(this.productId, 'sellings', 'min');
    }

    getSellNowPrice() {
      return this.nowPriceSetter(this.productId, 'buyings', 'max');
    }

    async getNowPrice() {
      return this.nowPriceSetter(
        this.productId,
        this.counterTable,
        this.minOrMax
      );
    }

    async getRecentDealPrice() {
      try {
        const [bidPrice] = await this.appDataSource.query(
          ` 
              SELECT 
                  b.bid_price AS bidPrice
              FROM deals d
              JOIN buyings b ON b.id = d.buying_id
              WHERE d.created_at = 
              (SELECT max(d.created_at) 
              FROM deals 
              JOIN buyings b ON b.id = d.buying_id 
              WHERE b.product_id = ${this.productId}) 
              AND b.product_id = ${this.productId}
              ORDER BY d.created_at DESC
              `
        );

        if (bidPrice == undefined) {
          return null;
        }

        return parseFloat(Object.values(bidPrice));
      } catch (err) {
        throw new DatabaseError('DATABASE_ERROR');
      }
    }
   };
  ```
  <br>

  - ì •ë³´ë¥¼ í•˜ë‚˜ì˜ ê°ì²´ë¡œ í•©í•˜ì—¬ ì „ë‹¬í•˜ëŠ” producService ë‚´ í•¨ìˆ˜

  ```JavaScript
  //API/services/productService.js
  const productDao = require('../models/productDao');
  const { BaseError } = require('../utils/error');
  const { BidCase } = require('../models/bidDao');

  const getProductDetail = async (productId) => {
    const checkProductId = await productDao.isExistingProduct(productId);

    if (!checkProductId) {
      throw new BaseError('PRODUCT_DOES_NOT_EXIST', 404);
    }

    const productDetail = await productDao.productDetail(productId);
    const bidCase = new BidCase(productId);

    productDetail.buyNowPrice = await bidCase.getBuyNowPrice();
    productDetail.sellNowPrice = await bidCase.getSellNowPrice();
    productDetail.recentDealPrice = await bidCase.getRecentDealPrice();
    productDetail.recentDealPrice == null
      ? (productDetail.premiumPercent = null)
      : (productDetail.premiumPercent = (
          ((productDetail.recentDealPrice - productDetail.originalPrice) /
            productDetail.originalPrice) *
          100
        ).toFixed(1));

    return productDetail;
  };
  ```
  </div>
  </details>
  
  <br>
  
 #### 2. ê²½ë§¤ ì…ì°° API - API classí™”
 - 'êµ¬ë§¤ ì…ì°°'ê³¼ 'íŒë§¤ ì…ì°°'ì„ ëª¨ë‘ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” í•˜ë‚˜ì˜ APIë¥¼ ì‘ì„±í•˜ê³ ì í–ˆìŠµë‹ˆë‹¤.
 - ì²˜ìŒì—ëŠ” í•¨ìˆ˜ì™€ ê°ì²´ë¥¼ í™œìš©í•˜ì—¬ ê²½ìš°ì— ë”°ë¼ ì ì ˆí•œ ê°’ì„ ê°ì²´ì˜ propertyì—ì„œ ë¶ˆëŸ¬ì™€ í•¨ìˆ˜ì˜ ì¸ìë¡œ ì‚¬ìš©í•˜ê³ ì í–ˆìŠµë‹ˆë‹¤.
 - ê·¸ëŸ¬ë‚˜ ê° ê²½ìš°ì— ë”°ë¼ ë‹¬ë¼ì ¸ì•¼ í•˜ëŠ” ë³€ìˆ˜ì˜ ìˆ˜ê°€ ë§ì•„, ë‹¤ìˆ˜ì˜ ê°ì²´ë¥¼ ì°¸ì¡°í•˜ê²Œ ë˜ë©´ì„œ ì½”ë“œì˜ ê°€ë…ì„±ì´ ë–¨ì–´ì§€ê³  ë³µì¡ì„±ì´ ë†’ì•„ì§„ë‹¤ê³  íŒë‹¨í•˜ì˜€ìŠµë‹ˆë‹¤.
 - ì´ì— ëŒ€í•´ ê³ ì•ˆí•´ë‚¸ ë°©ë²•ì€ classë¥¼ í™œìš©í•˜ì—¬ propertyì™€ ë©”ì„œë“œë¥¼ í•œ ë²ˆì— í™œìš©í•˜ëŠ” ê²ƒì´ì—ˆìŠµë‹ˆë‹¤.
    <details>
    <summary>ì‘ì„±í•œ ì½”ë“œ</summary>
    <div markdown="1">
      
      - bidDao ë‚´ ì…ì°° ê´€ë ¨ ë¡œì§ì„ ì²˜ë¦¬í•˜ëŠ” class
      
      ```JavaScript
      //API/models/bidDao.js

      class BidCase {
        constructor(productId, bidType, bidPrice = null, dueDate = null, userId) {
          this.bidType = bidType;
          this.bidPrice = bidPrice;
          this.productId = productId;
          this.counterpart = bidType == 'buying' ? 'selling' : 'buying';
          this.commissionRate = bidType == 'buying' ? 0.02 : 0.05;
          this.counterCommissionRate = bidType == 'buying' ? 0.05 : 0.02;
          this.table = `${bidType}s`;
          this.counterTable = `${this.counterpart}s`;
          this.minOrMax = this.counterpart == 'selling' ? 'min' : 'max';
          this.dueDate = dueDate;
          this.userId = userId;
          this.appDataSource = appDataSource;
        }

        async nowPriceSetter(productIdValue, table, minOrMax) {
          try {
            const [bidPrice] = await this.appDataSource.query(
              ` 
              SELECT 
                  bid_price bidPrice
              FROM ${table}
              WHERE bid_price = (
                SELECT ${minOrMax}(bid_price) 
                FROM ${table} 
                WHERE bid_status_id = ${bidStatusEnum.bid} 
                AND product_id = ${productIdValue}) 
              `
            );

            if (bidPrice == undefined) {
              return null;
            }

            return parseFloat(Object.values(bidPrice));
          } catch (err) {
            throw new DatabaseError('DATABASE_ERROR');
          }
        }

        getBuyNowPrice() {
          return this.nowPriceSetter(this.productId, 'sellings', 'min');
        }

        getSellNowPrice() {
          return this.nowPriceSetter(this.productId, 'buyings', 'max');
        }

        async getNowPrice() {
          return this.nowPriceSetter(
            this.productId,
            this.counterTable,
            this.minOrMax
          );
        }

        async getRecentDealPrice() {
          try {
            const [bidPrice] = await this.appDataSource.query(
              ` 
                  SELECT 
                      b.bid_price AS bidPrice
                  FROM deals d
                  JOIN buyings b ON b.id = d.buying_id
                  WHERE d.created_at = 
                  (SELECT max(d.created_at) 
                  FROM deals 
                  JOIN buyings b ON b.id = d.buying_id 
                  WHERE b.product_id = ${this.productId}) 
                  AND b.product_id = ${this.productId}
                  ORDER BY d.created_at DESC
                  `
            );

            if (bidPrice == undefined) {
              return null;
            }

            return parseFloat(Object.values(bidPrice));
          } catch (err) {
            throw new DatabaseError('DATABASE_ERROR');
          }
        }

        async isNowPrice() {
          const nowPrice = await this.getNowPrice();
          if (
            nowPrice &&
            ((this.bidType == 'buying' && this.bidPrice - nowPrice >= 0) ||
              (this.bidType == 'selling' && this.bidPrice - nowPrice <= 0))
          ) {
            this.bidPrice = nowPrice;

            return this.bidPrice;
          }

          return false;
        }

        async isExistingBid() {
          try {
            const [result] = await appDataSource.query(
              `SELECT EXISTS (
                  SELECT
                  id
                  FROM ${this.table}
                  WHERE user_id = ${this.userId} 
                  AND product_id = ${this.productId} 
                  AND bid_status_id = ${bidStatusEnum.bid}
                  ) existing 
                  `
            );
            return !!parseInt(result.existing);
          } catch (err) {
            throw new DatabaseError('DATABASE_ERROR');
          }
        }

        async biddingIn() {
          const queryRunner = this.appDataSource.createQueryRunner();
          await queryRunner.connect();
          await queryRunner.startTransaction();
          try {
            await this.isNowPrice();
            if (await this.isExistingBid()) {
              await queryRunner.query(
                `UPDATE ${this.table}
              SET bid_price = ?,
                  due_date = ?
              WHERE user_id = ? 
              AND product_id = ? 
              AND bid_status_id = ?`,
                [
                  this.bidPrice,
                  this.dueDate,
                  this.userId,
                  this.productId,
                  bidStatusEnum.bid,
                ]
              );

              const [bidding] = await queryRunner.query(
                `SELECT
                  id
              FROM ${this.table}
              WHERE user_id = ${this.userId} 
              AND product_id = ${this.productId} 
              AND bid_status_id = ${bidStatusEnum.bid}
              `
              );
              this.biddingId = bidding.id;
            } else {
              const bidding = await queryRunner.query(
                ` INSERT INTO ${this.table} (
                      product_id,
                      bid_price,
                      due_date,
                      user_id
                      )
                      VALUES (?, ?, ?, ?)`,
                [this.productId, this.bidPrice, this.dueDate, this.userId]
              );

              this.biddingId = bidding.insertId;
            }

            if (!(await this.isNowPrice())) {
              await queryRunner.commitTransaction();
              return;
            }

            const [partner] = await queryRunner.query(
              `SELECT
              id,
              user_id userId 
              FROM ${this.counterTable}
              WHERE updated_at = 
              (SELECT 
                  min(updated_at)
              FROM ${this.counterTable}
              WHERE product_id = ${this.productId} 
              AND bid_price = ${this.bidPrice} 
              AND bid_status_id = ${bidStatusEnum.bid})
              AND product_id = ${this.productId} 
              AND bid_price = ${this.bidPrice} 
              AND bid_status_id = ${bidStatusEnum.bid}
              ORDER BY updated_at`
            );

            if (partner.userId == this.userId) {
              throw new DatabaseError('SAME_USER_WITH_COUNTERPART');
            }

            await queryRunner.query(
              `UPDATE ${this.table} t
              JOIN ${this.counterTable} c
              SET t.bid_status_id = ${bidStatusEnum.deal},
                  c.bid_status_id = ${bidStatusEnum.deal}
              WHERE t.id = ${this.biddingId} 
              AND c.id = ${partner.id}`
            );

            const dealInput = await queryRunner.query(
              ` INSERT INTO deals (
                  ${this.bidType + '_id'},
                  ${this.counterpart + '_id'},
                  ${this.bidType + '_commission'},
                  ${this.counterpart + '_commission'}
                  )
                  VALUES (?, ?, ?, ?)`,
              [
                this.biddingId,
                partner.id,
                this.commissionRate * this.bidPrice,
                this.counterCommissionRate * this.bidPrice,
              ]
            );

            [this.dealInfo] = await queryRunner.query(
              `
              SELECT
                  id,
                  deal_number dealNumber
              FROM deals
              WHERE id = ?`,
              [dealInput.insertId]
            );

            await queryRunner.commitTransaction();

            return;
          } catch (err) {
            await queryRunner.rollbackTransaction();
            err.message = err.message || 'DATABASE_ERROR';
            err.statusCode = 400;
            throw err;
          } finally {
            await queryRunner.release();
          }
        }
      ```
      - bidDaoì˜ classë¥¼ ì‹¤í–‰ì‹œí‚¤ëŠ” bidService
                                                                          
      ```JavaScript
      //API/services/bidService.js
      const inputBidPrice = async (productId, bidType, bidPrice, dueDate, userId) => {
        const bidCase = new BidCase(productId, bidType, bidPrice, dueDate, userId);

        return await bidCase.biddingIn();
      };
      ``` 
    </div>
    </details>
    
  - classë¥¼ ê¹Šì´ í•™ìŠµí•˜ëŠ” ê³„ê¸°ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.
  
<br>

 ## 6. ëŠë‚€ì /íšŒê³ 
 > 2ì°¨ í”„ë¡œì íŠ¸ íšŒê³ ë¡: https://walwaldev.tistory.com/57

  <br>
  
 ## Reference

- ì´ í”„ë¡œì íŠ¸ëŠ” [KREAM](https://kream.co.kr/) ì‚¬ì´íŠ¸ë¥¼ ì°¸ì¡°í•˜ì—¬ í•™ìŠµëª©ì ìœ¼ë¡œ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.
- ì‹¤ë¬´ìˆ˜ì¤€ì˜ í”„ë¡œì íŠ¸ì´ì§€ë§Œ í•™ìŠµìš©ìœ¼ë¡œ ë§Œë“¤ì—ˆê¸° ë•Œë¬¸ì— ì´ ì½”ë“œë¥¼ í™œìš©í•˜ì—¬ ì´ë“ì„ ì·¨í•˜ê±°ë‚˜ ë¬´ë‹¨ ë°°í¬í•  ê²½ìš° ë²•ì ìœ¼ë¡œ ë¬¸ì œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ì´ í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©í•˜ê³  ìˆëŠ” ì‚¬ì§„ ëŒ€ë¶€ë¶„ì€ ìœ„ì½”ë“œì—ì„œ êµ¬ë§¤í•œ ê²ƒì´ë¯€ë¡œ í•´ë‹¹ í”„ë¡œì íŠ¸ ì™¸ë¶€ì¸ì´ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
